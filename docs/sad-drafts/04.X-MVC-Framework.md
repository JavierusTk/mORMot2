# 4.X. MVC Framework

*Model-View-Controller Made Simple*

## 4.X.1. Overview

The mORMot 2 MVC framework provides a **transport-agnostic** implementation of the Model-View-Controller pattern, integrated with the REST/ORM stack. It separates presentation logic (Views), business logic (Controllers), and data (Models) while supporting multiple rendering engines and session management strategies.

**Key Features**:

- **Transport-agnostic core**: Abstract MVC logic in `mormot.core.mvc` (no HTTP dependency)
- **Mustache template engine**: High-performance HTML rendering with partials and helpers
- **Multiple session strategies**: Cookie-based, in-memory, or custom implementations
- **REST integration**: `TMvcApplicationRest` bridges MVC with `TRestServer`
- **Automatic caching**: Configurable per-method with session-aware policies
- **Interface-based routing**: Define controllers using standard Delphi interfaces
- **Expression helpers**: ORM-to-Mustache integration for dynamic data binding

## 4.X.2. Architecture

### Component Stack

```
┌─────────────────────────────────────────────┐
│  Application Layer                          │
│  ┌───────────────────────────────────────┐  │
│  │ Your IMvcApplication implementation   │  │
│  │ (Controllers/ViewModels)              │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────────┐
│  MVC Framework (mormot.core.mvc)            │
│  ┌─────────────┬──────────────┬──────────┐  │
│  │ TMvcRun     │ TMvcSession* │ TMvcViews│  │
│  │ (Runner)    │ (Sessions)   │ (Render) │  │
│  └─────────────┴──────────────┴──────────┘  │
└─────────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────────┐
│  Integration Layer (mormot.rest.mvc)        │
│  ┌───────────────────────────────────────┐  │
│  │ TMvcApplicationRest                   │  │
│  │ TMvcRunOnRestServer                   │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────────┐
│  Model Layer (REST/ORM)                     │
│  ┌───────────────────────────────────────┐  │
│  │ TRestServer                           │  │
│  │ TOrm classes                          │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### Core Components

**MVC Application** (`TMvcApplication`):
- Base controller class implementing `IMvcApplication` interface
- Manages routing, session handling, and view rendering
- Supports dependency injection via `TInjectableObject` ancestry

**MVC Views** (`TMvcViewsAbstract` / `TMvcViewsMustache`):
- Template rendering engine abstraction
- Default implementation uses Mustache templates
- Automatic template discovery and hot-reload support

**MVC Session** (`TMvcSessionAbstract` / `TMvcSessionWithCookies`):
- Session state management strategies
- Cookie-based sessions with AES-GCM-128 encryption
- Unique session IDs (like JWT "jti" claim)

**MVC Renderer** (`TMvcRenderer*` classes):
- Request processing and response generation
- Supports HTML (via views) or JSON output
- Built-in caching with configurable policies

**MVC Run** (`TMvcRun` / `TMvcRunWithViews`):
- Execution context for MVC applications
- Manages view lifecycle and cache coordination
- Bridges controller methods to HTTP/transport layer

## 4.X.3. Defining a Controller

### Interface Definition

Controllers are defined using standard Delphi interfaces inheriting from `IMvcApplication`:

```pascal
type
  IBlogApplication = interface(IMvcApplication)
    ['{12345678-1234-1234-1234-123456789012}']
    procedure ArticleView(ID: TID; var Article: TOrmArticle; var Scope: variant);
    procedure AuthorView(var Author: TOrmAuthor; var Scope: variant);
    function Login(const LogonName, PlainPassword: RawUtf8): TMvcAction;
    function Logout: TMvcAction;
  end;
```

**Method patterns**:

- `procedure MethodName(var Scope: variant)` - View method with data context
- `function MethodName(...): TMvcAction` - Action method with redirect capability
- Parameters can include ORM objects (`var Article: TOrmArticle`)

### Implementation Class

```pascal
type
  TBlogApplication = class(TMvcApplicationRest, IBlogApplication)
  public
    procedure ArticleView(ID: TID; var Article: TOrmArticle; var Scope: variant);
    procedure AuthorView(var Author: TOrmAuthor; var Scope: variant);
    function Login(const LogonName, PlainPassword: RawUtf8): TMvcAction;
    function Logout: TMvcAction;
  end;

procedure TBlogApplication.ArticleView(ID: TID; var Article: TOrmArticle;
  var Scope: variant);
begin
  // Retrieve article from Model (TRestServer)
  if not RestModel.Orm.Retrieve(ID, Article) then
  begin
    RedirectError(HTTP_NOTFOUND);
    exit;
  end;

  // Add custom context data
  TDocVariantData(Scope).AddValue('views', Article.Views + 1);

  // Template receives: {{main}}, {{Article}}, {{Scope}}
end;

function TBlogApplication.Logout: TMvcAction;
begin
  CurrentSession.Finalize;
  GotoDefault(result);
end;
```

## 4.X.4. View Templates (Mustache)

### Template Structure

Templates are stored in a designated folder (default: `Views/`) with automatic discovery:

```
Views/
├── ArticleView.html        # Main view template
├── AuthorView.html
├── Login.html
├── Error.html              # Required error view
├── Default.html            # Required default view
└── Partials/
    ├── Header.partial      # Reusable partial
    └── Footer.partial
```

### Mustache Syntax

```mustache
<!DOCTYPE html>
<html>
<head>
  <title>{{Article.Title}}</title>
</head>
<body>
  {{>Header}}

  <article>
    <h1>{{Article.Title}}</h1>
    <p class="meta">By {{Article.AuthorName}} on {{Article.PublishedDate}}</p>
    <div class="content">
      {{{Article.Content}}}  <!-- Triple braces = unescaped HTML -->
    </div>
  </article>

  {{#Scope.views}}
    <p>Views: {{Scope.views}}</p>
  {{/Scope.views}}

  {{>Footer}}
</body>
</html>
```

**Available context**:

- `{{main}}` - Standard application info (name, version, session)
- `{{MethodParam}}` - Any `var` parameter from controller method
- `{{Scope.field}}` - Custom data added to `Scope` variant

### Expression Helpers

Register custom Mustache helpers for dynamic content:

```pascal
// Built-in crypto helpers
Views.RegisterExpressionHelpersForCrypto;

// Usage in template:
// <img src="https://www.gravatar.com/avatar/{{md5 email}}?s=200">

// ORM table helpers
RegisterExpressionHelpersForTables(Views, RestServer, [TOrmArticle, TOrmAuthor]);

// Usage in template:
// {{#TOrmArticle 123}}
//   <p>{{Title}}: {{Content}}</p>
// {{/TOrmArticle 123}}
```

## 4.X.5. Session Management

### Cookie-Based Sessions

`TMvcSessionWithCookies` provides secure, encrypted session storage:

```pascal
type
  TBlogSession = record
    ID: integer;
    UserName: RawUtf8;
    DisplayName: RawUtf8;
    Rights: integer;
  end;

// Initialize session at login
function TBlogApplication.Login(const LogonName, PlainPassword: RawUtf8): TMvcAction;
var
  Session: TBlogSession;
begin
  // Validate credentials against Model
  if ValidateUser(LogonName, PlainPassword, Session) then
  begin
    // Store session in encrypted cookie
    CurrentSession.Initialize(@Session, TypeInfo(TBlogSession), 60);
    GotoView(result, 'Default');
  end
  else
    GotoError(result, 'Invalid credentials', HTTP_FORBIDDEN);
end;

// Retrieve session in other methods
procedure TBlogApplication.ArticleView(ID: TID; var Article: TOrmArticle;
  var Scope: variant);
var
  Session: TBlogSession;
begin
  // Check session and retrieve data
  if CurrentSession.CheckAndRetrieve(@Session, TypeInfo(TBlogSession)) > 0 then
    TDocVariantData(Scope).AddValue('user', Session.UserName);

  // ... rest of method
end;
```

**Session features**:

- **Encrypted**: AES-GCM-128 with temporary secret key
- **Signed**: Digital signature prevents tampering
- **Expiring**: Configurable timeout (default 60 minutes)
- **Invalidatable**: One-time use or explicit finalization
- **Persistable**: `SaveContext`/`LoadContext` for server restart

### Session Strategies

```pascal
// Cookie-based (HTTP/REST)
TMvcSessionWithCookies    // Abstract base
TMvcSessionWithRestServer // TRestServer integration
TMvcSessionWithRenderer   // Direct HTTP renderer

// In-memory (single client, e.g., VCL/FMX GUI)
TMvcSessionSingle

// Custom implementation
TMvcSessionAbstract       // Inherit for custom storage
```

## 4.X.6. Running the MVC Application

### REST Server Integration

```pascal
uses
  mormot.rest.mvc, mormot.core.mustache;

var
  Server: TRestServerDB;
  Application: TBlogApplication;
  Runner: TMvcRunOnRestServer;
begin
  // Create REST server (the Model)
  Server := TRestServerDB.Create(Model, 'blog.db');

  // Create MVC application (Controller)
  Application := TBlogApplication.Create;
  Application.Start(Server, TypeInfo(IBlogApplication));

  // Create runner with Views
  Runner := TMvcRunOnRestServer.Create(
    Application,
    'Views',              // Template folder
    Server,               // REST server
    '',                   // Sub-URI (empty = root methods)
    nil,                  // Auto-create Mustache views
    [publishMvcInfo,      // Enable /mvc-info endpoint
     publishStatic,       // Enable /.static/ folder
     cacheStatic]         // Cache static files
  );

  // Server now responds to:
  //   /ArticleView?ID=123
  //   /AuthorView?ID=42
  //   /Login
  //   /mvc-info            (debug info)
  //   /.static/style.css   (static resources)
end;
```

### Caching Configuration

```pascal
Runner.SetCache('ArticleView', cacheRootWithSession, 300)  // 5 min per session
      .SetCache('AuthorView', cacheRootIgnoringSession)    // Shared cache
      .SetCache('Default', cacheNone);                     // No caching
```

**Cache policies**:

- `cacheNone` - No caching (dynamic content)
- `cacheRootIgnoringSession` - Shared cache (all users see same content)
- `cacheRootIfSession` - Cache only for logged-in users
- `cacheRootIfNoSession` - Cache only for guests
- `cacheRootWithSession` - Separate cache per session
- `cacheWithParameters*` - Cache varies by query string parameters

## 4.X.7. TMvcAction - Controller Actions

### Action Methods

Methods returning `TMvcAction` can redirect or change HTTP status:

```pascal
function TBlogApplication.DeleteArticle(ID: TID): TMvcAction;
begin
  if not RestModel.Orm.Delete(TOrmArticle, ID) then
  begin
    GotoError(result, 'Article not found', HTTP_NOTFOUND);
    exit;
  end;

  // Redirect to list after successful deletion
  GotoView(result, 'ArticleList', [], HTTP_TEMPORARYREDIRECT);
end;
```

**Helper methods**:

```pascal
// Redirect to another view
procedure GotoView(var Action: TMvcAction; const MethodName: RawUtf8;
  const ParametersNameValuePairs: array of const;
  Status: cardinal = HTTP_TEMPORARYREDIRECT);

// Redirect to error view
procedure GotoError(var Action: TMvcAction; const Msg: string;
  ErrorCode: integer = HTTP_BADREQUEST);

// Redirect to default view
procedure GotoDefault(var Action: TMvcAction;
  Status: cardinal = HTTP_TEMPORARYREDIRECT);
```

### Exception-Based Flow Control

For exceptional cases (has performance overhead):

```pascal
procedure TBlogApplication.ArticleView(ID: TID; var Article: TOrmArticle;
  var Scope: variant);
begin
  if not RestModel.Orm.Retrieve(ID, Article) then
    EMvcApplication.GotoError('Article not found', HTTP_NOTFOUND);
    // Execution stops here - no need for exit

  // Normal processing continues
  TDocVariantData(Scope).AddValue('title', Article.Title);
end;
```

## 4.X.8. Advanced Features

### ORM Expression Helpers

Automatically generate Mustache helpers for all ORM tables:

```pascal
RegisterExpressionHelpersForTables(Views, RestServer);

// In template - retrieve and display article by ID:
{{#TOrmArticle 123}}
  <h1>{{Title}}</h1>
  <p>{{Content}}</p>
{{/TOrmArticle 123}}

// Generate HTML table from ORM record:
{{#TOrmArticle.HtmlTable ArticleData}}
  <!-- Auto-generates Bootstrap-styled table -->
{{/TOrmArticle.HtmlTable ArticleData}}
```

### Custom Rendering

Bypass view templates and return custom content:

```pascal
procedure TBlogApplication.ArticleJson(ID: TID; var Article: TOrmArticle);
begin
  if RestModel.Orm.Retrieve(ID, Article) then
    // Return raw JSON (access via /ArticleJson/json?ID=123)
    exit;

  RedirectError(HTTP_NOTFOUND);
end;
```

### Event Hooks

```pascal
Application.OnBeforeRender := OnBeforeRenderEvent;
Application.OnAfterRender := OnAfterRenderEvent;
Application.OnSessionCreate := OnSessionCreateEvent;
Application.OnSessionFinalized := OnSessionFinalizedEvent;

function OnBeforeRenderEvent(Sender: TMvcRendererReturningData): boolean;
begin
  // Modify Sender.InputContext^ before rendering
  TDocVariantData(Sender.InputContext^).AddValue('timestamp', NowUtc);
  result := true; // Continue rendering
end;
```

### Static File Serving

```pascal
// Automatic serving from Views/.static/ folder
Runner.PublishOptions := Runner.PublishOptions + [publishStatic, cacheStatic];

// Custom static content
Runner.AddStaticCache('custom.css', '/custom.css',
  StringFromFile('path/to/custom.css'), 'text/css');
```

### Template Hot-Reload

```pascal
// Configure automatic template refresh every 5 seconds (development mode)
var
  Params: TMvcViewsMustacheParameters;
begin
  Params.Folder := 'Views';
  Params.FileTimestampMonitorAfterSeconds := 5;

  Views := TMvcViewsMustache.Create(TypeInfo(IBlogApplication), Params);
end;

// Disable in production:
Params.FileTimestampMonitorAfterSeconds := 0;
```

## 4.X.9. Best Practices

### Separation of Concerns

```pascal
// ✅ GOOD - Thin controller, data in Model
procedure TBlogApplication.ArticleList(var Articles: TOrmArticleDynArray;
  var Scope: variant);
begin
  // Retrieve data from Model
  RestModel.Orm.RetrieveListJson(TOrmArticle, '', [], Articles);

  // Minimal presentation logic
  TDocVariantData(Scope).AddValue('count', length(Articles));
end;

// ❌ BAD - Business logic in controller
procedure TBlogApplication.ArticleList(var Scope: variant);
var
  Json: RawUtf8;
begin
  // Don't build complex queries here - use Model/Services
  Json := RestModel.ExecuteSql('SELECT ... complex joins ...');
  TDocVariantData(Scope).AddValue('data', _JsonFast(Json));
end;
```

### Caching Strategy

```pascal
// Public pages - cache aggressively
Runner.SetCache('ArticleView', cacheRootIgnoringSession, 600);  // 10 min

// User-specific pages - cache per session
Runner.SetCache('Dashboard', cacheRootWithSession, 60);         // 1 min

// Admin/forms - no cache
Runner.SetCache('EditArticle', cacheNone);
```

### Session Security

```pascal
// Store only non-sensitive session data in cookies
type
  TBlogSession = record
    ID: integer;           // ✅ Session ID
    UserName: RawUtf8;     // ✅ Display name
    IsAdmin: boolean;      // ❌ Security attribute - verify against Model!
  end;

// Always verify rights from Model
procedure TBlogApplication.DeleteArticle(ID: TID; var Action: TMvcAction);
var
  Session: TBlogSession;
  User: TOrmUser;
begin
  CurrentSession.CheckAndRetrieve(@Session, TypeInfo(TBlogSession));

  // ❌ BAD - Trust cookie data
  if Session.IsAdmin then
    RestModel.Orm.Delete(TOrmArticle, ID);

  // ✅ GOOD - Verify against Model
  User := TOrmUser.Create(RestModel.Orm, Session.ID);
  try
    if User.IsAdmin then
      RestModel.Orm.Delete(TOrmArticle, ID);
  finally
    User.Free;
  end;
end;
```

### Error Handling

```pascal
procedure TBlogApplication.ArticleView(ID: TID; var Article: TOrmArticle;
  var Scope: variant);
begin
  // Prefer early-exit pattern over exceptions
  if ID <= 0 then
  begin
    RedirectError(HTTP_BADREQUEST, 'Invalid article ID');
    exit;
  end;

  if not RestModel.Orm.Retrieve(ID, Article) then
  begin
    RedirectError(HTTP_NOTFOUND, 'Article not found');
    exit;
  end;

  // Normal processing
  TDocVariantData(Scope).AddValue('title', Article.Title);
end;
```

## 4.X.10. Performance Characteristics

**View rendering** (from `mormot.core.mvc.pas` implementation):

- Template parsing: One-time cost per template file
- Mustache rendering: ~500K renders/second (simple templates)
- Cache lookup: ~10M/second (radix tree, method+session key)
- Cookie encryption: AES-GCM-128 (~1-2μs per cookie)

**Optimization tips**:

- Enable `cacheStatic` for CSS/JS/images
- Use `cacheRootIgnoringSession` for public pages
- Set appropriate `TimeOutSeconds` per cache policy
- Use `RegisterExpressionHelpersForTables` sparingly (adds RTTI overhead)
- Minimize `var` parameters in controller methods (each becomes template context)

## 4.X.11. Related Documentation

- **Mustache Templates**: `mormot.core.mustache.pas` ([Mustache specification](https://mustache.github.io))
- **REST Server**: See Chapter 24 (REST/ORM Server)
- **Interface Routing**: `TInterfaceFactory` in `mormot.core.interfaces.pas`
- **Session Encryption**: `TBinaryCookieGenerator` in `mormot.crypt.secure.pas`
- **Expression Helpers**: `TSynMustacheHelpers` in `mormot.core.mustache.pas`

---

**Example Projects**:

- `ex/ThirdPartyDemos/martin-doyle/` - Full blog application
- `test/mormot2tests.dpr` - `TTestCoreProcess._TUriTree` (routing benchmarks)

---

**Status**: Production-ready - Used in multiple high-traffic web applications since mORMot 1
