## 26.3.5. Command-Line Tools

The **mORMot 2 framework** includes a suite of command-line utilities built on the framework itself, demonstrating real-world applications while providing essential functionality for development, deployment, and operations.

**Location:** `/mnt/w/mORMot2/src/tools/`

**Common Architecture:**
- **Entry point**: `<tool>.dpr` (console application)
- **Implementation**: Either inline in `.dpr` or separate `mormot.tools.<tool>.pas` unit
- **Cross-platform**: Windows, Linux, macOS support
- **Dependencies**: Relative paths to mORMot core units
- **Compiler support**: Delphi (`.dproj`) and Free Pascal (`.lpi`)

All tools follow a consistent pattern using `mormot.app.console.pas` for RTTI-based command-line parsing, help text generation, and error handling.

---

### ecc - Public Key Cryptography Tool

**Purpose:** Certificate-based public key cryptography using ECC-secp256r1

**Implementation:**
- **Location**: `/mnt/w/mORMot2/src/tools/ecc/`
- **Core unit**: `mormot.tools.ecc.pas` (1,000+ lines)
- **Entry point**: `ecc.dpr`

**17 Command Categories:**

**Key Management (4 commands):**
```bash
ecc new [options]               # Create new private/public key pair
ecc rekey <keyfile> [options]   # Change private key password
ecc source <keyfile> [options]  # Generate .inc Pascal source file
ecc infopriv <keyfile>          # Display private key information
```

**Digital Signatures (2 commands):**
```bash
ecc sign <file> <keyfile>       # Sign file with ECDSA
ecc verify <file> [keyfile]     # Verify file signature
```

**Encryption (3 commands):**
```bash
ecc crypt <file> <pubkey>       # Encrypt with ECIES
ecc decrypt <file> <privkey>    # Decrypt .synecc file
ecc infocrypt <file>            # Display encryption metadata
```

**Symmetric Encryption (2 commands):**
```bash
ecc aeadcrypt <file> [password] # AEAD encryption
ecc aeaddecrypt <file> [password] # AEAD decryption
```

**Certificate Chains (2 commands):**
```bash
ecc chain <cert1> [cert2...]    # Create certificate chain
ecc chainall                    # Chain all .public files in folder
```

**Password Manager (2 commands):**
```bash
ecc cheatinit                   # Initialize password database
ecc cheat [name]                # Manage passwords
```

**Architecture:**
- Uses `TEccCertificate` from `mormot.crypt.ecc.pas` for key pair management
- Password-protected private keys with PBKDF2 (configurable rounds, default: 60,000)
- `.synecc` encrypted file format with embedded metadata
- `.ca` JSON arrays for certificate chain storage
- Secure key deletion (memory wiping)
- Certificate expiration validation

**Example Usage:**
```bash
# Generate new key pair
ecc new --issuer="MyCompany" --password="secret"

# Sign a file
ecc sign myapp.exe mykey.private --password="secret"

# Verify signature
ecc verify myapp.exe mykey.public

# Encrypt file for recipient
ecc crypt document.pdf recipient.public

# Decrypt received file
ecc decrypt document.pdf.synecc mykey.private
```

**Security Features:**
- ECDSA signatures using secp256r1 curve
- ECIES encryption with authenticated encryption
- Hardware acceleration (SHA-NI on x64)
- Configurable PBKDF2 iterations
- Secure password input (no echo)

---

### mget - HTTP/HTTPS Download Tool

**Purpose:** Advanced HTTP/HTTPS file downloader with resume, hash verification, and peer-to-peer caching

**Implementation:**
- **Location**: `/mnt/w/mORMot2/src/tools/mget/`
- **Core unit**: `mormot.tools.mget.pas` (350+ lines)
- **Entry point**: `mget.dpr`

**Key Features:**

**1. Resume Downloads**
- Uses HTTP `RANGE` headers for partial content
- `.part` extension for incomplete files
- Automatic continuation from last byte

**2. Hash Verification**
- Supports MD5, SHA-1, SHA-256, SHA-384, SHA-512, SHA-3
- Auto-download hash from `<url>.sha256` or `.md5`
- Manual hash specification via command line
- SHA-NI hardware acceleration on x64

**3. Peer-to-Peer Cache (Unique Feature)**
- LAN-based file sharing to reduce WAN bandwidth
- UDP broadcast discovery with AES-GCM-128 authentication
- Local HTTP cache server with bearer authentication
- Hash-based storage prevents tampering
- IP banning for DOS protection

**Common Usage:**
```bash
# Basic download with resume support
mget https://example.com/file.ext

# With hash verification (embedded)
mget 4544b3...68ba7a@https://example.com/file.ext

# Download hash first, then verify
mget https://example.com/file.ext --hashAlgo sha256

# Interactive mode
mget --prompt

# Interactive with peer cache
mget --prompt --peer
```

**Architecture:**
- Built on `THttpClientSocket.WGet()` from `mormot.net.client.pas`
- PeerCache uses `THttpPeerCache` from `mormot.net.server.pas`
- Secret-derived AES-GCM for UDP/HTTP authentication
- Streaming transfers (no full file buffering)
- Thread-safe peer cache background service

**Command-Line Options:**
```pascal
TMGetProcess = class
  Silent: boolean;              // Suppress console output
  NoResume: boolean;            // Disable resume capability
  Cache: boolean;               // Enable local cache
  Peer: boolean;                // Enable P2P peer cache
  LogSteps: boolean;            // Log detailed progress
  TrackNetwork: boolean;        // Monitor network changes
  CacheFolder: TFileName;       // Cache directory
  DestFile: TFileName;          // Output file name
  HashAlgo: TMGetProcessHash;   // Hash algorithm
  LimitBandwidthMB: integer;    // Bandwidth limit (MB/s)
  WholeRequestTimeoutSec: integer; // Total timeout
end;
```

**Peer Cache Benefits:**
- Download once, share across LAN
- Reduces external bandwidth usage
- Automatic failover to original URL
- Secure (authenticated broadcasts, optional TLS)

---

### agl (Angelize) - Cross-Platform Service Manager

**Purpose:** Manage multiple executables as daemon/services with watchdog monitoring

**Implementation:**
- **Location**: `/mnt/w/mORMot2/src/tools/agl/`
- **Core units**: `mormot.app.agl.pas`, `mormot.app.daemon.pas`
- **Entry point**: `agl.dpr`

**Key Features:**
- Main service (`TSynAngelize`) manages sub-processes
- JSON configuration files per sub-service
- Leveled startup (dependency rings)
- Auto-restart on crash with exponential backoff
- HTTP/HTTPS health check validation
- Console output redirection to log files
- HTML status page generation
- Thread-safe process monitoring with watchdog timers

**Command-Line Interface:**

**Service Lifecycle:**
```bash
agl /install                    # Install as Windows service / Linux daemon
agl /start                      # Start the service
agl /stop                       # Stop the service
agl /uninstall                  # Uninstall service
```

**Testing & Debugging:**
```bash
agl /run                        # Run in console mode
agl /verbose                    # Verbose console mode
agl /list                       # Show current status of all sub-processes
```

**Configuration Management:**
```bash
agl /new <servicename>          # Create new service config template
agl /settings                   # Validate JSON configuration
agl /retry                      # Force restart of failed service
```

**Architecture:**
```
TSynAngelize extends TSynDaemon (base daemon class)
  ├── Process monitoring thread per sub-service
  ├── Watchdog timer for health checks
  ├── Exit code handling (fatal vs. retryable)
  └── Graceful shutdown (WM_QUIT/SIGTERM) with fallback kill
```

**JSON Configuration Example:**
```json
{
  "Executable": "/path/to/myapp",
  "Arguments": "--port 8080",
  "WorkingDirectory": "/var/myapp",
  "RedirectOutput": "/var/log/myapp.log",
  "HealthCheck": "http://localhost:8080/health",
  "HealthCheckIntervalSec": 60,
  "RestartOnCrash": true,
  "StartupRing": 1
}
```

**Use Cases:**
- Deploy multiple mORMot HTTP servers as single service
- Manage microservices with dependency ordering
- Production monitoring with health checks
- Centralized logging from multiple processes

---

### mab - Debug Symbol Converter

**Purpose:** Convert debugging symbols to `.mab` format for stack trace resolution

**Implementation:**
- **Location**: `/mnt/w/mORMot2/src/tools/mab/`
- **Implementation**: Inline in `mab.dpr` (~100 lines)

**Operations:**
- **Input**: `.map` files (Delphi) or DWARF debugging info (FPC)
- **Output**: `.mab` binary format (mORMot Advanced Binding)
- **Embedding**: Inject `.mab` into executables (`.exe`, `.dll`, `.bpl`, `.ocx`)

**Usage:**
```bash
# Convert all .map files to .mab in current directory
mab *.map

# Process myapp.map and embed into myapp.exe
mab myapp.exe

# Create standalone .mab file
mab somefile.map
```

**Architecture:**
- Validates `.map` is newer than executable before processing
- Embeds `.mab` as resource or appended data
- Used by `mormot.core.log.pas` for stack trace symbolication
- Reads DWARF sections on FPC platforms

**Integration with mORMot Logging:**
```pascal
// Automatic stack trace resolution
TSynLog.Family.Level := LOG_STACKTRACE;

// Exception logging now includes resolved symbols
try
  DoSomething;
except
  on E: Exception do
    TSynLog.Add.Log(sllException, E); // Stack trace with symbols
end;
```

**Benefits:**
- Smaller than `.map` files (binary format)
- Embedded directly in executables (no separate file)
- Fast lookup for exception logging
- Cross-platform (Delphi + FPC)

---

### mopenapi - OpenAPI/Swagger Code Generator

**Purpose:** Generate Delphi/FPC client `.pas` units from OpenAPI/Swagger `.json` specifications

**Implementation:**
- **Location**: `/mnt/w/mORMot2/src/tools/mopenapi/`
- **Core unit**: `mormot.net.openapi.pas`
- **Entry point**: `mopenapi.dpr`

**Usage:**
```bash
# Display help
mopenapi --help

# Generate client from Swagger spec
mopenapi swagger.json PetStore

# Concise output (minimal comments)
mopenapi OpenApiAuth.json /concise

# Custom generation options
mopenapi test.json --options=DtoNoExample,DtoNoPattern

# Specify destination folder
mopenapi spec.json --destinationfolder=./generated
```

**Generated Code:**
- Type-safe Pascal interfaces for API endpoints
- DTO (Data Transfer Object) record types
- JSON serialization/deserialization
- Client implementation using `THttpClientSocket`
- Optional documentation comments

**Command-Line Options:**
```pascal
type
  TOpenApiParserOptions = set of (
    opoGenerateDtoNoExample,   // Omit example values
    opoGenerateDtoNoPattern,   // Omit regex patterns
    opoGenerateConcise,        // Minimal comments
    opoGenerateOptionalFields  // Make fields optional
  );
```

**Architecture:**
- RTTI-based command-line parsing
- OpenAPI 3.0 specification parser
- Type mapping (JSON → Pascal)
- Interface generation for REST endpoints
- Supports authentication schemes

**Example Generated Interface:**
```pascal
type
  IPetStoreApi = interface
    ['{...}']
    function GetPetById(petId: Int64): TPet;
    procedure AddPet(const pet: TPet);
    procedure UpdatePet(const pet: TPet);
    procedure DeletePet(petId: Int64);
  end;
```

**Blog Reference:** [Swagger/OpenAPI Client Generator for Delphi and FPC](https://blog.synopse.info/?post/2024/09/06/Swagger/OpenAPI-Client-Generator-for-Delphi-and-FPC)

---

### Build Requirements

**Delphi:**
- RAD Studio (uses `.dproj` project files)
- Compiler directives: `{$I ..\..\mormot.defines.inc}` and `{$I ..\..\mormot.uses.inc}`
- Windows manifest resource for console applications

**Free Pascal:**
- Uses `.lpi` project files (Lazarus IDE)
- Same include files for cross-platform compatibility
- DWARF debugging support (mab tool)

**Common Includes Pattern:**
```pascal
{$I ..\..\mormot.defines.inc}

{$ifdef OSWINDOWS}
  {$apptype console}
  {$R ..\..\mormot.win.default.manifest.res}
{$endif OSWINDOWS}

uses
  {$I ..\..\mormot.uses.inc}
  classes,
  sysutils,
  mormot.core.base         in '..\..\core\mormot.core.base.pas',
  mormot.core.os           in '..\..\core\mormot.core.os.pas',
  // ... more units
```

---

### Testing Tools

Each tool includes built-in help and can be validated:

```bash
# Display help for any tool
ecc --help
mget --help
agl /help
mab --help
mopenapi --help

# Test with sample files
ecc new --issuer="Test" --password="test"
mget --prompt
agl /verbose
mab *.map
mopenapi swagger.json TestAPI
```

**Integration Testing:**
- Tools can be tested via `mormot.test.*.pas` units in `/mnt/w/mORMot2/test/`
- Cross-platform builds verified on Windows, Linux, macOS
- Basic operations with sample files
- Error condition handling (missing files, invalid input)

---

### Related Documentation

- **[Source Code Structure](../mORMot2-SAD-Chapter-26.md)** - Repository layout and compilation
- **[Cryptography Framework](../mORMot2-SAD-Chapter-21.md)** - ECC foundation (ecc tool)
- **[Network Layer](../mORMot2-SAD-Chapter-20.md)** - HTTP client/server (mget, agl)
- **[Application Framework](../mORMot2-SAD-Chapter-19.md)** - Console and daemon classes

**Additional Resources:**
- `/mnt/w/mORMot2/src/tools/README.md` - Quick reference
- `/mnt/w/mORMot2/src/tools/CLAUDE.md` - AI development guidelines
- Individual tool README files in respective directories
